c:\Users\albs_\source\repos\msx-tests\line-interrupt.s1FNAME "line-interrupt.rom" 36PageSize: equ 0x4000 89 org 0x4000, 0xbeff 11 Include/RomHeader.s12 db "AB" 3 dw Execute 4 dw 0 6 dw 0 8 dw 0 9 dw 0, 0, 0 10 11c:\Users\albs_\source\repos\msx-tests\line-interrupt.s13CHPUT: equ 0x00a2 14CHGMOD: equ 0x005f15WRTVDP: equ 0x004716WRTVRM: equ 0x004d 17NRDVRM: equ 0x0174 18NWRVRM: equ 0x0177 19NSTWRT: equ 0x0171 20BEEP: equ 0x00c021SNSMAT: equ 0x014123PORT_0: equ 0x9824PORT_1: equ 0x9925PORT_2: equ 0x9a26PORT_3: equ 0x9b28REG0SAV: equ 0xF3DF3031PPI.A: equ $a8 33PPI.B: equ $a9 34PPI.C: equ $aa 40PPI.R: equ $ab 47Execute:49 50 xor a51 ld (Flag_IN), a52 ld (Counter_T), a53 ld (Var_P), a54 ld a, 155 ld (Direction), a56 60 61 ld b, 10 62 ld c, 8 63 call WRTVDP 64 65 66 67 ld a, 868 call CHGMOD71 73 74 ld hl, 075 call NSTWRT76 ld c, PORT_078 ld iyl, 079.loop_Y: 80 ld ixl, 081 .loop_X:82 ld a, iyl83 xor ixl85 out (c), a87 89 inc ixl90 jp nz, .loop_X91 92 inc iyl93 jp nz, .loop_Y94 96 98 100 di101 102 109 114 117 ld a, 0xc3 118 ld (0xfd9a), a119 ld hl, .line_80120 ld (0xfd9a + 1), hl122 124 126 ld a, (REG0SAV)127 or 16128 ld b, a 129 ld c, 0 130 call WRTVDP_without_DI_EI 133 135 ld b, 100 136 ld c, 19 137 call WRTVDP_without_DI_EI 140 142 ei144 150 151.readKeyBoard:152 153 ld a, 8 155 call SNSMAT_NO_DI_EI156 bit 0, a 157 jp z, .exit 159 jp .readKeyBoard161.exit:162 164 ld a, (REG0SAV)165 and 239166 ld b, a 167 ld c, 0 168 call WRTVDP 170 172 ld a, 201173 ld (-614), a175 177 call BEEP179 ret 181.line_80:183 187 192 ld a, (Flag_IN)193 or a194 jp nz, .else195196 ld a, 1197 ld (Flag_IN), a198 call .sub_470199 xor a200 ld (Flag_IN), a201 ld (Counter_T), a202 ret203.else:204 205 ld hl, Counter_T206 inc (hl)207 208 209 ld a, (hl)210 cp 100211 ret nz213 xor a214 ld (Counter_T), a215 ld (Flag_IN), a216 ret220.sub_470:221 223 ld b, 1224 call RDSTATUSREG225 226 ld a, 1227 and b228 229 cp 1230 231 jp z, .sub_470_line_530232 233 236 ld b, 0 237 ld c, 23 238 call WRTVDP_without_DI_EI 239 di240 241 ret243.sub_470_line_530:244 248 ld a, (Var_P)249 ld b, a 250 ld c, 23 251 call WRTVDP_without_DI_EI 253 254 ld a, (Direction)255 ld b, a256 ld a, (Var_P)257 add a, b258 ld (Var_P), a260 261 cp 0262 jp z, .setDirection_Plus_1263 cp 64264 jp z, .setDirection_Minus_1265 266 ret267 268.setDirection_Plus_1:269 ld a, 1270 ld (Direction), a271 ret272.setDirection_Minus_1:273 ld a, -1274 ld (Direction), a275 ret277280284RDSTATUSREG:285286 ld a,(0007h) 287 inc a288 ld c,a 290 out (c),b291 ld a,080h+15292 out (c),a293294 295 ld a,(0006h) 296 inc a297 ld c,a 298 in b,(c) 299 300301 ld a,(0007h) 302 inc a303 ld c,a 304 xor a305 out (c),a306 ld a,080h+15307 out (c),a308 310 ret313314WRTVDP_without_DI_EI:315 ld a, b316 317 out (PORT_1),a318 ld a, c319 or 128320 322 out (PORT_1), a323 ret327330SNSMAT_NO_DI_EI:331 ld c, a332.C_OK:333334 in a, (PPI.C)335 and 0xf0 336 or c337338 out (PPI.C), a339 in a, (PPI.B)340 ret342 ds PageSize - ($ - 0x4000), 255 344345 org 0xc000347Flag_IN: rb 1348Counter_T: rb 1349Var_P: rb 1350351Direction: rb 1353 355 