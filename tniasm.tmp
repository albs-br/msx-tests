C:\Users\albs_\source\repos\msx-tests\opl4.s1 25FNAME "opl4.rom" 8ENASLT: equ 0x00249GTTRIG: equ 0x00D81112 org 0x40001415 db "AB"16 dw BEGIN17 dw 0, 0, 0, 0, 0, 021BEGIN: 23 di24 im 125 ld sp, 0xF38027 ld a, 0xc928 ld (0xfd9f), a 30 xor a31 ld (0x6000), a32 inc a33 ld (0x7000), a34 35 36 call figure_where_rom_is38 ld a, (0xf001)39 ld h, 0x80 40 call ENASLT 4344 xor a45 ld (0xF3DB), a 46 47 48 49 in a, (0xc4)50 cp 0xff51 jr z, $ 52 54 56 ld a, 557 out (0xc6), a 58 ld a, 259 out (0xc7), a 61 62 63 ld bc, 0x0210 64 call write_opl4_port65 66 ld bc, 0x2001 67 call write_opl4_port69 ld bc, 0x38F0 70 call write_opl4_port71 72 73 74 76 ld b, 277 call read_opl4_port78 or 1 79 8081 ld c, a82 call write_opl4_port83 84 86 ld bc, 0x032087 call write_opl4_port88 ld bc, 0x040089 call write_opl4_port90 ld bc, 0x050091 call write_opl4_port 92 93 ld a, 194 ld (0x7000), a 96 ld hl, 0x8000 97 ld de, headers_end - headers_begin98 ld b, 0x06 99loop_header:100 ld c, (hl)101 102 call write_opl4_port103 inc hl104 dec de105 ld a, d106 or e107 jr nz, loop_header108 110 111 112 113 115 ld bc, 0x0320116 call write_opl4_port117 ld bc, 0x0412118 call write_opl4_port119 ld bc, 0x0500120 call write_opl4_port 122 ld a, 2123 ld (0x7000), a124 call load_16kb_chunk125 ld a, 3126 ld (0x7000), a127 call load_16kb_chunk 128 ld a, 4129 ld (0x7000), a130 call load_16kb_chunk131 132 134 135 ld b, 2136 call read_opl4_port137 and 11111110b 138 139140 ld c, a141 call write_opl4_port144 ei145 146 xor a147 ld (0xefff), a 148 149 ld a, 0x80 152 ld (0xeffe), a 156 157wait_space_loop:158 xor a159 call GTTRIG 160 or a161 jr z, clean_keypress162 163 ld a, (0xefff)164 or a165 jr nz,wait_space_loop166 167 ld a, 1168 ld (0xefff), a 169 170 ld a, (0xeffe) 171 ld d, a172 call speak173 174 ld a, d 175 cp 0x80 + 2176 jr z, .reset177 inc a178 jr .cont179.reset:180 ld a, 0x80 181.cont:182 ld (0xeffe), a183 184 jr wait_space_loop185 186 187clean_keypress:188 xor a189 ld (0xefff), a 190 jr wait_space_loop191 200 201 202 203 204 205 206207speak:208 ld bc, 0x6800 209 call write_opl4_port 211 ld b, 0x08 212 ld c, d 213 call write_opl4_port 215 ld bc, 0x6880 216 jp write_opl4_port 219 220 221 222 223 224 226228write_opl4_port:229 230 ld a, b231 out (0x7e), a232 ld a, c233 nop234 nop235 236 out (0x7f), a237 ret238 239 241244read_opl4_port:245 246 ld a, b247 out (0x7e), a248 nop249 nop250 nop251 252 in a, (0x7f)253 ret257258load_16kb_chunk:259 ld hl, 0x8000260 ld de, 0x4000 261 ld b, 0x06 262loop_data:263 ld c, (hl)264 265 call write_opl4_port266 inc hl267 dec de268 ld a, d269 or e270 jr nz, loop_data271 ret281 282 283284figure_where_rom_is: 285 jp search_slot286 287 288 289293 294search_slot:295 296 call 0x0138 297 rrca298 rrca299 and 3300 ld c, a301 ld b, 0302 ld hl, 0x0FCC1303 add hl, bc304 ld a, (hl)305 and 0x80306 or c307 ld c, a308 inc hl309 inc hl310 inc hl311 inc hl312 ld a, (hl)313 and 0x0C314 or c315 ld h, 0x80316 ld (0xf001), a317 ret 318 319 ds 0x8000 - $320325 326 327 336 337 338 339 340 org 0x00341headers_begin: 342 344 345 346sample_0_size: equ sample_0_end - sample_0347 db 0x20, 0x12, 0x00 348 db (sample_0_size) >> 8349 db (sample_0_size) and 0xff350 db ((sample_0_size) xor 0xffFF) >> 8351 db ((sample_0_size) xor 0xffFF) and 0xff352 db 0x00, 0xf0, 0x00, 0x00, 0x00 353 356 358 360sample_1_size: equ sample_1_end - sample_1361 db sample_1 >> 16, (sample_1 >> 8) and 0xff, sample_1 and 0xff 362 db (sample_1_size) >> 8363 db (sample_1_size) and 0xff364 db ((sample_1_size) xor 0xffFF) >> 8365 db ((sample_1_size) xor 0xffFF) and 0xff366 db 0x00, 0xf0, 0x00, 0x00, 0x00 370 373sample_2_size: equ sample_2_end - sample_2374 db sample_2 >> 16, (sample_2 >> 8) and 0xff, sample_2 and 0xff 375 db (sample_2_size) >> 8376 db (sample_2_size) and 0xff377 db ((sample_2_size) xor 0xffFF) >> 8378 db ((sample_2_size) xor 0xffFF) and 0xff379 db 0x00, 0xf0, 0x00, 0x00, 0x00 381headers_end: 382 ds 16 * 1024 - $383 384 385 386 387 388 389 390 391 org 0x201200392sample_0: 393 incbin "Sound/opl4/ApplauseModerate2_11Kh_signed8bits.raw"394sample_0_end:395 396sample_1: 397 incbin "Sound/opl4/bitvision_female_british.raw"398sample_1_end:399 400sample_2: 401 incbin "Sound/opl4/hello_signed_8bits_11000hz.raw"402sample_2_end:403 ds 0x201200 + (16384 * 4) - $404 405 406 407