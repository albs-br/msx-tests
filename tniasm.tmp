c:\Users\albs_\source\repos\msx-tests\line-interrupt.s1FNAME "line-interrupt.rom" 3PageSize: equ 0x4000 56 org 0x4000, 0xbeff 8 Include/RomHeader.s12 db "AB" 3 dw Execute 4 dw 0 6 dw 0 8 dw 0 9 dw 0, 0, 0 10 11c:\Users\albs_\source\repos\msx-tests\line-interrupt.s10CHPUT: equ 0x00a2 11CHGMOD: equ 0x005f12WRTVDP: equ 0x004713WRTVRM: equ 0x004d 14NRDVRM: equ 0x0174 15NWRVRM: equ 0x0177 16NSTWRT: equ 0x0171 17BEEP: equ 0x00c018SNSMAT: equ 0x014120PORT_0: equ 0x9821PORT_1: equ 0x9922PORT_2: equ 0x9a23PORT_3: equ 0x9b25REG0SAV: equ 0xF3DF2728PPI.A: equ $a8 30PPI.B: equ $a9 31PPI.C: equ $aa 37PPI.R: equ $ab 44Execute:46 47 xor a48 ld (Flag_IN), a49 ld (Counter_T), a50 ld (Var_P), a51 ld a, 152 ld (Direction), a53 ld hl, 054 ld (Var_AD), hl57 58 ld b, 10 59 ld c, 8 60 call WRTVDP 61 62 63 64 ld a, 865 call CHGMOD68 70 71 ld hl, 072 call NSTWRT73 ld c, PORT_075 ld iyl, 076.loop_Y: 77 ld ixl, 078 .loop_X:79 ld a, iyl80 xor ixl82 out (c), a84 86 inc ixl87 jp nz, .loop_X88 89 inc iyl90 jp nz, .loop_Y91 93 95 97 di98 99 106 111 114 ld a, 0xc3 115 ld (0xfd9a), a116 ld hl, .line_80117 ld (0xfd9a + 1), hl119 121 123 ld a, (REG0SAV)124 or 16125 ld b, a 126 ld c, 0 127 call WRTVDP_without_DI_EI 130 132 ld b, 100 133 ld c, 19 134 call WRTVDP_without_DI_EI 137 139 ei141 147 148.readKeyBoard:149 150 ld a, 8 152 call SNSMAT_NO_DI_EI153 bit 0, a 154 jp z, .exit 156 jp .readKeyBoard158.exit:159 161 ld a, (REG0SAV)162 and 239163 ld b, a 164 ld c, 0 165 call WRTVDP 167 169 ld a, 201170 ld (-614), a172 174 call BEEP176 ret 178.line_80:180 184 189 ld a, (Flag_IN)190 or a191 jp nz, .else192193 ld a, 1194 ld (Flag_IN), a195 call .sub_470196 xor a197 ld (Flag_IN), a198 ld (Counter_T), a199 ret200.else:201 202 ld hl, Counter_T203 inc (hl)204 205 206 ld a, (hl)207 cp 100208 ret nz210 xor a211 ld (Counter_T), a212 ld (Flag_IN), a213 ret217.sub_470:218 220 ld b, 1221 call RDSTATUSREG222 223 ld a, 1224 and b225 226 cp 1227 228 jp z, .sub_470_line_530229 230 233 ld b, 0 234 ld c, 23 235 call WRTVDP_without_DI_EI 236 di237 238 ret240.sub_470_line_530:241 245 ld a, (Var_P)246 ld b, a 247 ld c, 23 248 call WRTVDP_without_DI_EI 250 251 ld a, (Direction)252 ld b, a253 ld a, (Var_P)254 add a, b255 ld (Var_P), a257 258 cp 0259 jp z, .setDirection_Plus_1260 cp 64261 jp z, .setDirection_Minus_1262 263 ret264 265.setDirection_Plus_1:266 ld a, 1267 ld (Direction), a268 ret269.setDirection_Minus_1:270 ld a, -1271 ld (Direction), a272 ret274277281RDSTATUSREG:282283 ld a,(0007h) 284 inc a285 ld c,a 287 out (c),b288 ld a,080h+15289 out (c),a290291 292 ld a,(0006h) 293 inc a294 ld c,a 295 in b,(c) 296 297298 ld a,(0007h) 299 inc a300 ld c,a 301 xor a302 out (c),a303 ld a,080h+15304 out (c),a305 307 ret310311WRTVDP_without_DI_EI:312 ld a, b313 314 out (PORT_1),a315 ld a, c316 or 128317 319 out (PORT_1), a320 ret322 ds PageSize - ($ - 0x4000), 255 326329SNSMAT_NO_DI_EI:330 ld c, a331.C_OK:332333 in a, (PPI.C)334 and 0xf0 335 or c336337 out (PPI.C), a338 in a, (PPI.B)339 ret341342 org 0xc000344Flag_IN: rb 1345Counter_T: rb 1346Var_P: rb 1347Var_AD: rw 1348Direction: rb 1350 352 